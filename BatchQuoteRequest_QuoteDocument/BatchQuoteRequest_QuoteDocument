global class BatchQuoteRequest_QuoteDocument implements Database.Batchable<SObject>, Database.Stateful{
    
    
    
    List<Sales_Ops_Requests__c> requests = new List<Sales_Ops_Requests__c>();
    
    Map<String,Id> quoteSalesOpsRequestMap = new Map<String,Id>();
    
    List<SBQQ__Quote__c> quoteList = new List<SBQQ__Quote__c>();
    
    
    
    
    global BatchQuoteRequest_QuoteDocument(Map<String,Id> quoteSalesOpsRequestMap, List<Sales_Ops_Requests__c> requests, List<SBQQ__Quote__c> quoteList){
        
        this.quoteSalesOpsRequestMap = quoteSalesOpsRequestMap;
        this.requests = requests;
        this.quoteList = quoteList;
        
    }
    
    
    
    global Database.QueryLocator start(Database.BatchableContext bc) {
        
        List<ID> requestIds = new List<ID>();
        
        for(Sales_Ops_Requests__c request : requests){
            
            requestIds.add(request.id);
        }
        
        system.debug('requestIds: '+ requestIds);
        
        
        String salesOpsRequests = 'SELECT ID, Quote_Name__c, Quote_Template_Name__c, OPPORTUNITY__c FROM Sales_Ops_Requests__c WHERE Id in :requestIds';
        
        return Database.getQueryLocator(salesOpsRequests);
    }
    
    
    
    global void execute(Database.BatchableContext bc, List<Sales_Ops_Requests__c> scope){
        
        
        for(SBQQ__Quote__c quote : quoteList){
            
            quote.Recalculate__c = FALSE;
            
        }
        
        update quoteList;
        
        
        List<SBQQ__QuoteDocument__c> quoteDocList = new List<SBQQ__QuoteDocument__c>();
        
        
        List<QuoteDocGenerator.QuoteDocRequest> quoteDocRequestList = new List<QuoteDocGenerator.QuoteDocRequest>();
        
        
        
        try{
            
            system.debug('scope: '+ scope);
            
            for(Sales_Ops_Requests__c request : scope){
                
                QuoteDocGenerator.QuoteDocRequest req = new QuoteDocGenerator.QuoteDocRequest();
                
                req.quoteId = quoteSalesOpsRequestMap.get(request.id);
                
                req.templateName = request.Quote_Template_Name__c;
                
                req.quoteName = request.Quote_Name__c;
                
                quoteDocRequestList.add(req);
                
                system.debug('quoteSalesOpsRequestMap.get(request.id): '+ quoteSalesOpsRequestMap.get(request.id));
                system.debug('request.Quote_Template_Name__c: '+ request.Quote_Template_Name__c);
                system.debug('request.Quote_Name__c: '+ request.Quote_Name__c);
                
                
                
            }
            
            QuoteDocGenerator.createNew(quoteDocRequestList);
            
        }
        
        catch(Exception e){
            String sub3 = 'Exception Thrown - Failed to Create Quote Document';
            String body3 = 'Exception Thrown - Failed to Create Quote Document: ' + e.getMessage() + '\n Stack Trace: ' + e.getStackTraceString();
            errorHandler(sub3,body3);
            
        }
        
        
        
    }
    
    
    
    
    
    
    
    global void finish(Database.BatchableContext bc){
        
        system.debug('yay');
        
        
        
        
    }
    
    public static void errorHandler(String sub, String body){
        
        List<String> errorEmailList = new List<String>{'salesops@goguardian.com'};
            Messaging.SingleEmailMessage msg = new Messaging.SingleEmailMessage();
        
        msg.setSubject(sub);
        msg.setToAddresses(errorEmailList);
        msg.setPlainTextBody(body);
        Messaging.sendEmail(new List<Messaging.SingleEmailMessage> { msg }, false);
        
    }
    
    
}
