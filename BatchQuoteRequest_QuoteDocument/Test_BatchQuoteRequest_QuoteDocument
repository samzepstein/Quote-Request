@isTest
public class Test_BatchQuoteRequest_QuoteDocument {
    
    
    @testSetup
    public static void setupTests(){
        
        
        
        ID stdPricebook = Test.getStandardPricebookId();
        
        Account testAccount = new Account(Name='Test Account');
        
        insert testAccount;
        
        //Opportunity
        Opportunity oppty2 = new Opportunity();
        oppty2.Name = 'Test oppty';
        oppty2.Type = 'New';
        oppty2.AccountId = testAccount.Id;
        oppty2.StageName = 'Closing';
        oppty2.CloseDate = System.today();
        oppty2.Channel__c = 'Direct';
        oppty2.Manually_Remove_From_Analysis__c = TRUE;
        oppty2.Pricebook2Id = stdPricebook;
        
        
        insert oppty2;
        
        
        
        Sales_Ops_Requests__c request = new Sales_Ops_Requests__c();
        
        request.Name = 'Test Quote Req';
        request.OPPORTUNITY__c = oppty2.id;
        request.Primary_Account__c = testAccount.id;
        request.Price_Book__c = stdPricebook;
        request.Request_Subject__c = 'Test Quote Req';
        
        insert request;
        
        SBQQ__Quote__c quote = new SBQQ__Quote__c();
        
        quote.SBQQ__Primary__c = True;
        quote.SBQQ__Opportunity2__c = oppty2.id;
        quote.SBQQ__Status__c = 'Draft';
        quote.SBQQ__Account__c = oppty2.AccountId;
        quote.SBQQ__EndDate__c = system.today() + 365;
        quote.Sales_Ops_Request_ID__c = request.id;
        
        
        insert quote;
        
        
        
        // Create a product with a product code
        Product2 prod = new Product2();
        prod.Name='Webinar'; 
        prod.ProductCode ='WEB';
        prod.Family = 'Pear Deck - Services';
        
        
        INSERT prod;
        
        // Create Pricebook Entry on Standard Pricebook first
        PricebookEntry standardPrice = new PricebookEntry();
        standardPrice.Pricebook2Id = stdPricebook;
        standardPrice.Product2Id = prod.id;
        standardPrice.UnitPrice = 7.50;
        standardPrice.IsActive = true;
        standardPrice.UseStandardPrice = FALSE;
        
        INSERT standardPrice;
        
    }
    
    
    public static testMethod void quoteDocument(){
        
        
        Map<String,Id> quoteSalesOpsRequestMap = new Map<String,Id>();
        
        List<Sales_Ops_Requests__c> requests = new List<Sales_Ops_Requests__c>();
        
        List<SBQQ__Quote__c> quoteList = new List<SBQQ__Quote__c>();
        
        
        Sales_Ops_Requests__c request = [SELECT ID, OPPORTUNITY__c, Primary_Account__c, OPPORTUNITY__r.Pricebook2Id, Price_Book__c FROM Sales_Ops_Requests__c WHERE Name = 'Test Quote Req' LIMIT 1];
        
        
        SBQQ__Quote__c quote = [SELECT ID, Sales_Ops_Request_ID__c FROM SBQQ__Quote__c LIMIT 1];
        
        
        quoteList.add(quote);
        
        Product2 prod = [SELECT Id FROM Product2 LIMIT 1];
        
        SBQQ.TriggerControl.disable();
        
        
        SBQQ__QuoteLine__c qL = new SBQQ__QuoteLine__c();
        
        ql.SBQQ__Quote__c = quote.id;
        ql.SBQQ__StartDate__c = system.today();
        ql.SBQQ__StartDate__c = system.today() + 365;
        ql.SBQQ__Product__c = prod.id;
        ql.SBQQ__Quantity__c = 500;
        ql.Deal_Type__c = 'New';
        
        insert ql;
        

        SBQQ.TriggerControl.enable();
        
        quoteSalesOpsRequestMap.put(quote.Sales_Ops_Request_ID__c, quote.id);
        
        requests.add(request);
        
        Database.executeBatch(new BatchQuoteRequest_QuoteDocument(quoteSalesOpsRequestMap, requests, quoteList));
        
    }
    
}
