@isTest
public class Test_BatchQuoteRequest_QuoteLines {
    
    @testSetup
    public static void setupTests(){
        
   
        
        String volName = 'Volume Discount Schedule';
        String termName = 'Term Discount Schedule';
            
            
        
        SBQQ__DiscountSchedule__c volDiscSchedule = TestDataFactory.createDiscountSchedule(volName);
        
        SBQQ__DiscountSchedule__c termDiscSchedule = TestDataFactory.createDiscountSchedule(termName);

        
        
        list<SBQQ__DiscountTier__c> discTierList = new list<SBQQ__DiscountTier__c>();
        
        
        SBQQ__DiscountTier__c volumeDiscTier = new SBQQ__DiscountTier__c(SBQQ__UpperBound__c=1000,
                                                                         SBQQ__LowerBound__c=1,
                                                                         SBQQ__Discount__c=5,
                                                                         SBQQ__Schedule__c = volDiscSchedule.id);
        
        SBQQ__DiscountTier__c termDiscTier = new SBQQ__DiscountTier__c(SBQQ__UpperBound__c=13,
                                                                       SBQQ__LowerBound__c=1,
                                                                       SBQQ__Discount__c=10,
                                                                       SBQQ__Schedule__c = termDiscSchedule.id);
        
        
        discTierList.add(volumeDiscTier);
        discTierList.add(termDiscTier);
        
        insert discTierList;
        
        
        
        ID stdPricebook = Test.getStandardPricebookId();
        
        Account testAccount = new Account(Name='Test Account');
        
        insert testAccount;
        
        
        Opportunity oppty2 = TestDataFactory.createOpportunityWithPricebook(testAccount.id, stdPricebook);
        

        
        list<Product2> prodList = new list<Product2>();
        
        
        // Create a product with a product code
        Product2 prod = new Product2();
        prod.Name='Pear Deck Test'; 
        prod.ProductCode ='GG-PDECK';
        prod.Family = 'Pear Deck - Services';
        
        
        prodList.add(prod); 
        
        
        
        Product2 prod2 = new Product2();
        prod2.Name='Admin Implementation Service Test'; 
        prod2.ProductCode ='AI-S';
        prod2.SBQQ__SubscriptionPricing__c = 'Fixed Price';
        
        
        prodList.add(prod2);
        
        //suite Product
        Product2 prod3 = new Product2();
        prod3.Name='Suite'; 
        prod3.ProductCode ='GG-STE';
        prod3.SBQQ__SubscriptionPricing__c = 'Fixed Price';
        
        
        prodList.add(prod3);
        
        insert prodList;
        
        
        // Create Pricebook Entry on Standard Pricebook first
        PricebookEntry standardPrice = new PricebookEntry();
        standardPrice.Pricebook2Id = stdPricebook;
        standardPrice.Product2Id = prod.id;
        standardPrice.UnitPrice = 7.50;
        standardPrice.IsActive = true;
        standardPrice.UseStandardPrice = FALSE;
        
        INSERT standardPrice;
        
        
        // Create Pricebook Entry on Standard Pricebook first
        PricebookEntry standardPrice2 = new PricebookEntry();
        standardPrice2.Pricebook2Id = stdPricebook;
        standardPrice2.Product2Id = prod2.id;
        standardPrice2.UnitPrice = 10000;
        standardPrice2.IsActive = true;
        standardPrice2.UseStandardPrice = FALSE;
        
        INSERT standardPrice2;
        
        
        Sales_Ops_Requests__c request = new Sales_Ops_Requests__c();
        
        request.Name = 'Test Quote Req';
        request.OPPORTUNITY__c = oppty2.id;
        request.Primary_Account__c = testAccount.id;
        request.Price_Book__c = stdPricebook;
        request.Request_Subject__c = 'Test Quote Req';
        
        
        insert request;
        
        
        test.startTest();
        
        SBQQ__Quote__c quote = new SBQQ__Quote__c();
        
        quote.SBQQ__Opportunity2__c = oppty2.id;
        quote.SBQQ__Status__c = 'Draft';
        quote.SBQQ__Account__c = oppty2.AccountId;
        quote.SBQQ__EndDate__c = system.today() + 365;
        quote.Sales_Ops_Request_ID__c = request.id;
        
        
        insert quote; 
        
        
        
        
        
        test.stopTest();
        
        
        
        
    }
    
    
    
    public static testMethod void productWithFixedPrice(){
        
        
        test.startTest();
        
        
        Map<String,Id> quoteSalesOpsRequestMap = new Map<String,Id>();
        
        List<SBQQ__Quote__c> quoteList = new List<SBQQ__Quote__c>();
        
        List<Sales_Ops_Requests__c> requests = new List<Sales_Ops_Requests__c>();
        
        
        
        Sales_Ops_Requests__c request = [SELECT ID, OPPORTUNITY__c, Primary_Account__c, OPPORTUNITY__r.Pricebook2Id, Price_Book__c FROM Sales_Ops_Requests__c WHERE Name = 'Test Quote Req' LIMIT 1];
        
        SBQQ__DiscountSchedule__c volDiscSchedule = [SELECT id FROM SBQQ__DiscountSchedule__c where Name = 'Volume Discount Schedule' LIMIT 1];
        
        SBQQ__DiscountSchedule__c termDiscSchedule = [SELECT id FROM SBQQ__DiscountSchedule__c where Name = 'Term Discount Schedule' LIMIT 1];
        
        
        system.debug('termDiscSchedule :'+termDiscSchedule);
        
        SBQQ__Quote__c quote = [SELECT ID, Sales_Ops_Request_ID__c FROM SBQQ__Quote__c LIMIT 1];
        
        quoteList.add(quote);
        
        
        Product2 prod2 = [SELECT ID FROM Product2 WHERE SBQQ__SubscriptionPricing__c = 'Fixed Price' LIMIT 1];
        
        QLine__c qLine = new QLine__c();
        
        qLine.Discount__c = 5;
        qLine.Start_Date__c = system.today();
        qline.End_Date__c = system.today() + 365;
        qLine.Product__c = prod2.id;
        qLine.Sales_Ops_Request__c = request.id;
        qLine.Pricebook_and_Product__c = request.Price_Book__c + ' ' + prod2.id;
        qLine.Volume_Discount_Schedule__c = volDiscSchedule.id;
        qLine.Term_Discount_Schedule__c = termDiscSchedule.id;
        
        
        insert qLine;
        
        quoteSalesOpsRequestMap.put(quote.Sales_Ops_Request_ID__c, quote.id);
        
        requests.add(request);
        
        Database.executeBatch(new BatchQuoteRequest_QuoteLines(requests, quoteSalesOpsRequestMap, quoteList));
        
        test.stopTest();
        
    } 
    
    
    public static testMethod void productWithoutFixedPrice(){
        
        test.startTest();
        
        
        Map<String,Id> quoteSalesOpsRequestMap = new Map<String,Id>();
        
        List<SBQQ__Quote__c> quoteList = new List<SBQQ__Quote__c>();
        
        List<Sales_Ops_Requests__c> requests = new List<Sales_Ops_Requests__c>();
        
        
        
        Sales_Ops_Requests__c request = [SELECT ID, OPPORTUNITY__c, Primary_Account__c, OPPORTUNITY__r.Pricebook2Id, Price_Book__c FROM Sales_Ops_Requests__c WHERE Name = 'Test Quote Req' LIMIT 1];
        
        
        
        
        SBQQ__Quote__c quote = [SELECT ID, Sales_Ops_Request_ID__c FROM SBQQ__Quote__c LIMIT 1];
        
        quoteList.add(quote);
        
        Product2 prod2 = [SELECT ID FROM Product2 WHERE SBQQ__SubscriptionPricing__c != 'Fixed Price' LIMIT 1];
        
        QLine__c qLine = new QLine__c();
        
        qLine.Discount__c = 5;
        qLine.Start_Date__c = system.today();
        qline.End_Date__c = system.today() + 365;
        qLine.Product__c = prod2.id;
        qLine.Sales_Ops_Request__c = request.id;
        qLine.Pricebook_and_Product__c = request.Price_Book__c + ' ' + prod2.id;
        qLine.Amount__c = 1000;
        
        
        insert qLine;
        
        quoteSalesOpsRequestMap.put(quote.Sales_Ops_Request_ID__c, quote.id);
        
        requests.add(request);
        
        Database.executeBatch(new BatchQuoteRequest_QuoteLines(requests, quoteSalesOpsRequestMap, quoteList));
        
        test.stopTest();
    } 
    
    
    
    public static testMethod void productSuite(){
        
        
        test.startTest();
        
        
        Map<String,Id> quoteSalesOpsRequestMap = new Map<String,Id>();
        
        List<SBQQ__Quote__c> quoteList = new List<SBQQ__Quote__c>();
        
        List<Sales_Ops_Requests__c> requests = new List<Sales_Ops_Requests__c>();
        
        
        
        Sales_Ops_Requests__c request = [SELECT ID, OPPORTUNITY__c, Primary_Account__c, OPPORTUNITY__r.Pricebook2Id, Price_Book__c FROM Sales_Ops_Requests__c WHERE Name = 'Test Quote Req' LIMIT 1];
        
        SBQQ__DiscountSchedule__c volDiscSchedule = [SELECT id FROM SBQQ__DiscountSchedule__c where Name = 'Volume Discount Schedule' LIMIT 1];
        
        SBQQ__DiscountSchedule__c termDiscSchedule = [SELECT id FROM SBQQ__DiscountSchedule__c where Name = 'Term Discount Schedule' LIMIT 1];
        
        
        
        
        SBQQ__Quote__c quote = [SELECT ID, Sales_Ops_Request_ID__c FROM SBQQ__Quote__c LIMIT 1];
        
        quoteList.add(quote);
        
        
        Product2 prod2 = [SELECT ID, ProductCode FROM Product2 WHERE ProductCode ='GG-STE' LIMIT 1];
        
        QLine__c qLine = new QLine__c();
        
        qLine.Discount__c = 5;
        qLine.Start_Date__c = system.today();
        qline.End_Date__c = system.today() + 365;
        qLine.Product__c = prod2.id;
        qLine.Sales_Ops_Request__c = request.id;
        qLine.Pricebook_and_Product__c = request.Price_Book__c + ' ' + prod2.id;
        qLine.Volume_Discount_Schedule__c = volDiscSchedule.id;
        qLine.Term_Discount_Schedule__c = termDiscSchedule.id;
        
        
        insert qLine;
        
        quoteSalesOpsRequestMap.put(quote.Sales_Ops_Request_ID__c, quote.id);
        
        requests.add(request);
        
        Database.executeBatch(new BatchQuoteRequest_QuoteLines(requests, quoteSalesOpsRequestMap, quoteList));
        
        test.stopTest();
        
    } 
    
    
    
    public static testMethod void testError(){
        
        test.startTest();
        
        List<SBQQ__Quote__c> quoteList = new List<SBQQ__Quote__c>();
        

        
        Map<String,Id> quoteSalesOpsRequestMap = new Map<String,Id>();
        
        List<Sales_Ops_Requests__c> requests = new List<Sales_Ops_Requests__c>();
        
        
        
        Sales_Ops_Requests__c request = [SELECT ID, OPPORTUNITY__c, Primary_Account__c, OPPORTUNITY__r.Pricebook2Id, Price_Book__c FROM Sales_Ops_Requests__c WHERE Name = 'Test Quote Req' LIMIT 1];
        
        
        
        
        SBQQ__Quote__c quote = [SELECT ID, Sales_Ops_Request_ID__c FROM SBQQ__Quote__c LIMIT 1];
        
        quoteList.add(quote);
        
        Product2 prod2 = [SELECT ID, Family FROM Product2 WHERE Family = 'Pear Deck - Subscription' LIMIT 1];
        
        QLine__c qLine = new QLine__c();
        
        qLine.Discount__c = 5;
        qLine.Start_Date__c = system.today();
        qline.End_Date__c = system.today() + 365;
        qLine.Product__c = prod2.id;
        qLine.Sales_Ops_Request__c = request.id;
        qLine.Pricebook_and_Product__c = request.Price_Book__c + ' ' + prod2.id;
        //qLine.Amount__c = 1000;
        
        
        insert qLine;
        
        quoteSalesOpsRequestMap.put(quote.Sales_Ops_Request_ID__c, quote.id);
        
        requests.add(request);
        
        Database.executeBatch(new BatchQuoteRequest_QuoteLines(requests, quoteSalesOpsRequestMap, quoteList));
        
        test.stopTest();
    } 
    
}
