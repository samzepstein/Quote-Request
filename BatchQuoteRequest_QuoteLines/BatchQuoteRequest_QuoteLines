global class  BatchQuoteRequest_QuoteLines implements Database.Batchable<SObject>, Database.Stateful{
    
    List<Sales_Ops_Requests__c> requests = new List<Sales_Ops_Requests__c>();
    
    List<SBQQ__QuoteLine__c> quoteLineList = new List<SBQQ__QuoteLine__c>();
    
    List<SBQQ__QuoteLine__c> suiteQuoteLines = new List<SBQQ__QuoteLine__c>();
    
    Map<String,Id> quoteSalesOpsRequestMap = new Map<String,Id>();
    
    
    List<SBQQ__Quote__c> quoteList = new List<SBQQ__Quote__c>();
    
    
    global BatchQuoteRequest_QuoteLines(List<Sales_Ops_Requests__c> requests, Map<String,Id> quoteSalesOpsRequestMap, List<SBQQ__Quote__c> quoteList){
        this.requests = requests;
        this.quoteSalesOpsRequestMap = quoteSalesOpsRequestMap;
        this.quoteList = quoteList;
        
    }
    
    
    
    global Database.QueryLocator start(Database.BatchableContext bc) {
       
        String qLines = 'SELECT ID, Amount__c, Volume_Discount_Schedule__c, Discount__c, Product__c, Product__r.ProductCode, Product__r.Family, Quantity__c, Start_Date__c, End_Date__c, Pricebook_and_Product__c,' +
            'Sales_Ops_Request__r.id, Sales_Ops_Request__r.Price_Book__c FROM QLine__c WHERE Sales_Ops_Request__c in :requests';
        
        return Database.getQueryLocator(qLines);
    }
    
    //add term discount (excludes pear deck) - use Number of Months Fields
    //pass in map of discount tiers from the term discount schedule using the term discount field on QLine
    
    global Decimal calculateQuantity(QLine__c qLine, Map<Id,List<SBQQ__DiscountTier__c>> volumeDiscountScheduleTierMap, Map<String,Decimal> listPriceMap){
        
        
        Map<ID,SBQQ__DiscountTier__c> qlDiscMap = new Map<ID,SBQQ__DiscountTier__c>();
        
        
        Decimal volumeDisc;
        
        
        
        
        //convert quantity to integer and round up
        Decimal quantityDec = (qLine.Amount__c / listPriceMap.get(qLine.Pricebook_and_Product__c)).round(System.roundingMode.CEILING);
        
        Decimal unitPrice = listPriceMap.get(qLine.Pricebook_and_Product__c);
        
        system.debug('quantityDec: '+ quantityDec);
        
        
        system.debug('unitPrice: '+ unitPrice);                               
        
        
        
        for(Id discountSchedule : volumeDiscountScheduleTierMap.keySet()){
            
            
            system.debug('discountSchedule: '+ discountSchedule);
            
            system.debug('volumeDiscountScheduleTierMap.keySet(): '+ volumeDiscountScheduleTierMap.keySet());
            
            
            List<SBQQ__DiscountTier__c > volumeDiscTierList = volumeDiscountScheduleTierMap.get(discountSchedule);
            
            system.debug('volumeDiscTierList: '+ volumeDiscTierList);
            
            for(SBQQ__DiscountTier__c dt : volumeDiscTierList){
                
                system.debug('dt: '+ dt);
                
                if((quantityDec >= dt.SBQQ__LowerBound__c && quantityDec <= dt.SBQQ__UpperBound__c) || (quantityDec >= dt.SBQQ__LowerBound__c && dt.SBQQ__UpperBound__c == NULL)){
                    
                    //qlDiscMap.put(qLine.id, dt);
                    //
                    
                    system.debug('dt that meets criteria: '+ dt);
                    
                    volumeDisc = dt.SBQQ__Discount__c / 100;
                    
                    volumeDisc.setScale(2);
                    
                    break;
                    
                    
                    
                }
                
                
            }
            
        }
        
        Decimal volumeDiscAmount = unitPrice * volumeDisc;
        
        Decimal newUnitPrice = unitPrice - volumeDiscAmount;
        
        newUnitPrice.setScale(2);
        
        quantityDec = (qLine.Amount__c / newUnitPrice).round(System.roundingMode.CEILING);
        
        system.debug('volumeDiscAmount: '+ volumeDiscAmount);
        system.debug('newUnitPrice: '+ newUnitPrice);
        system.debug('volumeDisc: '+ volumeDisc);
        system.debug('quantityDec: '+ quantityDec);
        
        
        
        return quantityDec;
    }
    
    
    
    
    global void execute(Database.BatchableContext bc, List<QLine__c> scope){
        
        
        try{
            
            List<ID> priceBookList = new List<ID>();
            
            List<ID> productList = new List<ID>();
            
            List<ID> volumeDiscountScheduleList = new List<ID>();
            
            for(QLine__c qoLine : scope){
                
                priceBookList.add(qoLine.Sales_Ops_Request__r.Price_Book__c);
                
                productList.add(qoLine.Product__c);
                
                volumeDiscountScheduleList.add(qoLine.Volume_Discount_Schedule__c);
                
            }
            
            
            system.debug('priceBookList: '+ priceBookList);
            
            system.debug('productList: '+ productList);
            
            List<PricebookEntry> pbEntries = [SELECT ID, Product2Id, UnitPrice, Pricebook2Id 
                                              FROM PricebookEntry 
                                              WHERE Pricebook2Id in :priceBookList 
                                              AND Product2Id in :productList];
            
            
            Map<String,Decimal> listPriceMap = new Map<String,Decimal>();
            
            for(PricebookEntry pbEntry : pbEntries){
                
                listPriceMap.put(pbEntry.Pricebook2Id + ' ' + pbEntry.Product2Id, pbEntry.UnitPrice);
                
            }
            
            
            system.debug('listPriceMap: '+ listPriceMap);
            
            system.debug('pbEntries: '+ pbEntries);
            
            system.debug('QLscope: '+ scope);
            
            //List<SBQQ__QuoteLine__c> quoteLineList = new List<SBQQ__QuoteLine__c>();
            
            SBQQ.TriggerControl.disable();
            
            
            List<SBQQ__DiscountTier__c > volumeDiscountTierList = [SELECT ID, Name, SBQQ__Schedule__r.id, SBQQ__Discount__c, SBQQ__DiscountAmount__c, SBQQ__LowerBound__c, SBQQ__UpperBound__c
                                                             FROM SBQQ__DiscountTier__c 
                                                             WHERE SBQQ__Schedule__c in :volumeDiscountScheduleList];
            
            
            Map<Id,List<SBQQ__DiscountTier__c>> volumeDiscountScheduleTierMap = new Map<Id,List<SBQQ__DiscountTier__c>>();
            
            
            
            
            Map<Id,Decimal> volumeDiscountTierMap = new Map<Id,Decimal>();
            
            for(SBQQ__DiscountTier__c dt : volumeDiscountTierList){
                
                Id discountScheduleId = dt.SBQQ__Schedule__r.id;
                
                
                system.debug('discountScheduleId: '+ discountScheduleId);
                
                
                List<SBQQ__DiscountTier__c> volumeDisTierList = volumeDiscountScheduleTierMap.containsKey(discountScheduleId) ? volumeDiscountScheduleTierMap.get(discountScheduleId) : new List<SBQQ__DiscountTier__c>();
                
                
                system.debug('volumeDisTierList: '+ volumeDisTierList);
                
                volumeDiscountTierMap.put(dt.id, dt.SBQQ__Discount__c);
                
                volumeDisTierList.add(dt);
                
                
                volumeDiscountScheduleTierMap.put(discountScheduleId, volumeDisTierList);
                
            }
            
            
            
            
            
            system.debug('volumeDiscountTierList: '+ volumeDiscountTierList);
            
            //Key: DiscountSchedule Value: Discount Tiers
            system.debug('volumeDiscountScheduleTierMap: '+ volumeDiscountScheduleTierMap);
            
            //Key: Discount Tier Value: discount %
            system.debug('volumeDiscountTierMap: '+ volumeDiscountTierMap);
            
            
            
            
            for(QLine__c qLine : scope){
                
                SBQQ__QuoteLine__c qL = new SBQQ__QuoteLine__c();
                
                
                //exclude suite since unit price is 0. Do calculationin quote line bundles class - alsot= take in account option discount
                If(qLine.Product__r.Family != 'Pear Deck - Services' && qLine.Volume_Discount_Schedule__c != NULL){
                    
                    ql.SBQQ__Quantity__c = calculateQuantity(qLine, volumeDiscountScheduleTierMap, listPriceMap);
                    
                }
                
                
                else{
                    
                    ql.SBQQ__Quantity__c = qLine.Quantity__c;
                    
                }
                
                
                
                ql.SBQQ__StartDate__c = qLine.Start_Date__c;
                ql.SBQQ__EndDate__c = qLine.End_Date__c;
                ql.SBQQ__Product__c = qLine.Product__c;
                ql.Deal_Type__c = 'New';
                ql.SBQQ__Quote__c = quoteSalesOpsRequestMap.get(qLine.Sales_Ops_Request__r.id);
                ql.Sales_Discount__c = qLine.Discount__c;
                
                
                
            }
            
            
            system.debug('quoteSalesOpsRequestMap: '+ quoteSalesOpsRequestMap);
            
            system.debug('quoteLineList: '+ quoteLineList);
            
            
            
            insert quoteLineList;
            
            SBQQ.TriggerControl.enable();
            
        }
        
        catch(Exception e){
            String sub3 = 'Exception Thrown - Failed to Create Quote Lines';
            String body3 = 'Exception Thrown - Failed to Create Quote Lines: ' + e.getMessage() + '\n Stack Trace: ' + e.getStackTraceString();
            errorHandler(sub3,body3);
            
        }
        
        
    }
    
    
    global void finish(Database.BatchableContext bc){
        
        system.debug('quote lines created!');
        
        
        for(SBQQ__QuoteLine__c ql: quoteLineList){
            
            
            if(qL.ProductCode__c == 'GG-STE' || qL.ProductCode__c == 'GG-SCO' || qL.ProductCode__c == 'GG-STW'){
                
                suiteQuoteLines.add(ql);
                
                
            }
            
        } 
        
        system.debug('suiteQuoteLines: '+ suiteQuoteLines);
        
        
        if(suiteQuoteLines.size() > 0){
            

              Database.executeBatch(new BatchQuoteRequest_QuoteLineBundles(requests, quoteList, suiteQuoteLines, quoteSalesOpsRequestMap));
        }
        
        else{
            
            for(SBQQ__Quote__c quote : quoteList){
                
                quote.Recalculate__c = TRUE;
                
            }
            
            update quoteList;
            
            
            
            Database.executeBatch(new BatchQuoteRequest_QuoteDocument(quoteSalesOpsRequestMap, requests));
            
        }
        
    }
    
    
    public static void errorHandler(String sub, String body){
        
        List<String> errorEmailList = new List<String>{'salesops@goguardian.com'};
            Messaging.SingleEmailMessage msg = new Messaging.SingleEmailMessage();
        
        msg.setSubject(sub);
        msg.setToAddresses(errorEmailList);
        msg.setPlainTextBody(body);
        Messaging.sendEmail(new List<Messaging.SingleEmailMessage> { msg }, false);
        
    }
    
}
