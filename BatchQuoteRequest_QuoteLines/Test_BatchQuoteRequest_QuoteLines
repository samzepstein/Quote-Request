@isTest
public class Test_BatchQuoteRequest_QuoteLines {
    
    @testSetup
    public static void setupTests(){
        
        ID stdPricebook = Test.getStandardPricebookId();
        
        String volName = 'Volume Discount Schedule';
        
        SBQQ__DiscountSchedule__c volDiscSchedule = TestDataFactory.createDiscountSchedule(volName);
        
        SBQQ__DiscountTier__c volDiscScheduleTier = TestDataFactory.createDiscountScheduleTier(volDiscSchedule.id);
        
        
        
        Account testAccount = new Account(Name='Test Account');
        
        insert testAccount;
        
        //Opportunity
        Opportunity oppty2 = new Opportunity();
        oppty2.Name = 'Test oppty';
        oppty2.Type = 'New';
        oppty2.AccountId = testAccount.Id;
        oppty2.StageName = 'Closing';
        oppty2.CloseDate = System.today();
        oppty2.Channel__c = 'Direct';
        oppty2.Manually_Remove_From_Analysis__c = TRUE;
        oppty2.Pricebook2Id = stdPricebook;
        
        
        insert oppty2;
        
        
        // Create a product with a product code
        Product2 prod = new Product2();
        prod.Name='Webinar'; 
        prod.ProductCode ='WEB';
        prod.Family = 'Pear Deck - Services';
        
        
        INSERT prod;
        
        Product2 prod2 = new Product2();
        prod2.Name='Pear Deck Product Test'; 
        prod2.ProductCode ='AI-S';
        prod2.Family = 'Pear Deck - Subscription';
        prod.SBQQ__SubscriptionPricing__c = 'Fixed Price';
        
        
        INSERT prod2;
        
        
        // Create Pricebook Entry on Standard Pricebook first
        PricebookEntry standardPrice = new PricebookEntry();
        standardPrice.Pricebook2Id = stdPricebook;
        standardPrice.Product2Id = prod.id;
        standardPrice.UnitPrice = 7.50;
        standardPrice.IsActive = true;
        standardPrice.UseStandardPrice = FALSE;
        
        INSERT standardPrice;
        
        
        // Create Pricebook Entry on Standard Pricebook first
        PricebookEntry standardPrice2 = new PricebookEntry();
        standardPrice2.Pricebook2Id = stdPricebook;
        standardPrice2.Product2Id = prod2.id;
        standardPrice2.UnitPrice = 10000;
        standardPrice2.IsActive = true;
        standardPrice2.UseStandardPrice = FALSE;
        
        INSERT standardPrice2;
        
        
        Sales_Ops_Requests__c request = new Sales_Ops_Requests__c();
        
        request.Name = 'Test Quote Req';
        request.OPPORTUNITY__c = oppty2.id;
        request.Primary_Account__c = testAccount.id;
        request.Price_Book__c = stdPricebook;
        request.Request_Subject__c = 'Test Quote Req';
        
        insert request;
        
        
        test.startTest();
        
        SBQQ__Quote__c quote = new SBQQ__Quote__c();
        
        quote.SBQQ__Primary__c = True;
        quote.SBQQ__Opportunity2__c = oppty2.id;
        quote.SBQQ__Status__c = 'Draft';
        quote.SBQQ__Account__c = oppty2.AccountId;
        quote.SBQQ__EndDate__c = system.today() + 365;
        quote.Sales_Ops_Request_ID__c = request.id;
        
        
        insert quote; 
        
        test.stopTest();
        
        
        
        
    }
    
    public static testMethod void pearDeckSubscription(){
        
       
        
        Map<String,Id> quoteSalesOpsRequestMap = new Map<String,Id>();
        
        List<Sales_Ops_Requests__c> requests = new List<Sales_Ops_Requests__c>();
        
        List<SBQQ__Quote__c> quoteList = new List<SBQQ__Quote__c>();
        
        
        
        Sales_Ops_Requests__c request = [SELECT ID, OPPORTUNITY__c, Primary_Account__c, OPPORTUNITY__r.Pricebook2Id, Price_Book__c FROM Sales_Ops_Requests__c WHERE Name = 'Test Quote Req' LIMIT 1];
        
        SBQQ__DiscountSchedule__c voldisc = [SELECT ID, Name FROM SBQQ__DiscountSchedule__c WHERE Name = 'Volume Discount Schedule' LIMIT 1];
        
        
        SBQQ__Quote__c quote = [SELECT ID, Sales_Ops_Request_ID__c FROM SBQQ__Quote__c LIMIT 1];
        
        quoteList.add(quote);
        
        Product2 prod2 = [SELECT ID, Family FROM Product2 WHERE Family = 'Pear Deck - Subscription' LIMIT 1];
        
        QLine__c qLine = new QLine__c();
        
        qLine.Discount__c = 5;
        qLine.Start_Date__c = system.today();
        qline.End_Date__c = system.today() + 365;
        qLine.Product__c = prod2.id;
        qLine.Sales_Ops_Request__c = request.id;
        qLine.Pricebook_and_Product__c = request.Price_Book__c + ' ' + prod2.id;
        qLine.Amount__c = 1000;
        qLine.Volume_Discount_Schedule__c = voldisc.id;
 
        insert qLine;
        
        quoteSalesOpsRequestMap.put(quote.Sales_Ops_Request_ID__c, quote.id);
        
        requests.add(request);
        
        Database.executeBatch(new BatchQuoteRequest_QuoteLines(requests, quoteSalesOpsRequestMap, quoteList));
    } 
    
    
    
    public static testMethod void pearDeckServices(){
        
        
        Map<String,Id> quoteSalesOpsRequestMap = new Map<String,Id>();
        
        List<Sales_Ops_Requests__c> requests = new List<Sales_Ops_Requests__c>();
        
        List<SBQQ__Quote__c> quoteList = new List<SBQQ__Quote__c>();
        
        
        
        Sales_Ops_Requests__c request = [SELECT ID, OPPORTUNITY__c, Primary_Account__c, OPPORTUNITY__r.Pricebook2Id, Price_Book__c FROM Sales_Ops_Requests__c WHERE Name = 'Test Quote Req' LIMIT 1];
        
        
        
        
        SBQQ__Quote__c quote = [SELECT ID, Sales_Ops_Request_ID__c FROM SBQQ__Quote__c LIMIT 1];
        
        quoteList.add(quote);
        
        Product2 prod2 = [SELECT ID, Family FROM Product2 WHERE Family = 'Pear Deck - Services' LIMIT 1];
        
        QLine__c qLine = new QLine__c();
        
        qLine.Discount__c = 5;
        qLine.Start_Date__c = system.today();
        qline.End_Date__c = system.today() + 365;
        qLine.Product__c = prod2.id;
        qLine.Sales_Ops_Request__c = request.id;
        qLine.Pricebook_and_Product__c = request.Price_Book__c + ' ' + prod2.id;
        
        
        insert qLine;
        
        quoteSalesOpsRequestMap.put(quote.Sales_Ops_Request_ID__c, quote.id);
        
        requests.add(request);
        
        Database.executeBatch(new BatchQuoteRequest_QuoteLines(requests, quoteSalesOpsRequestMap, quoteList));
        
    } 
    
    
    
    
    
    public static testMethod void nonPearDeckServices_Error(){
        
        
        
        
        Map<String,Id> quoteSalesOpsRequestMap = new Map<String,Id>();
        
        List<Sales_Ops_Requests__c> requests = new List<Sales_Ops_Requests__c>();
        
        List<SBQQ__Quote__c> quoteList = new List<SBQQ__Quote__c>();
        
        
        
        Sales_Ops_Requests__c request = [SELECT ID, OPPORTUNITY__c, Primary_Account__c, OPPORTUNITY__r.Pricebook2Id, Price_Book__c FROM Sales_Ops_Requests__c WHERE Name = 'Test Quote Req' LIMIT 1];
        
        
        SBQQ__Quote__c quote = [SELECT ID, Sales_Ops_Request_ID__c FROM SBQQ__Quote__c LIMIT 1];
        
        quoteList.add(quote);
        
        Product2 prod2 = [SELECT ID, Family FROM Product2 WHERE Family = 'Pear Deck - Subscription' LIMIT 1];
        
        QLine__c qLine = new QLine__c();
        
        qLine.Discount__c = 5;
        qLine.Start_Date__c = system.today();
        qline.End_Date__c = system.today() + 365;
        qLine.Product__c = prod2.id;
        qLine.Sales_Ops_Request__c = request.id;
        qLine.Pricebook_and_Product__c = request.Price_Book__c + ' ' + prod2.id;
        //qLine.Amount__c = 1000;
        
        
        insert qLine;
        
        quoteSalesOpsRequestMap.put(quote.Sales_Ops_Request_ID__c, quote.id);
        
        requests.add(request);
        
        Database.executeBatch(new BatchQuoteRequest_QuoteLines(requests, quoteSalesOpsRequestMap, quoteList));
    } 
    
}
